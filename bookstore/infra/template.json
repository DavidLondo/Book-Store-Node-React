Resources:
  BookstoreVpcB6D31B20:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      InstanceTenancy: default
      Tags:
        - Key: Name
          Value: InfraStack/BookstoreVpc
    Metadata:
      aws:cdk:path: InfraStack/BookstoreVpc/Resource
  BookstoreVpcpublicSubnet1Subnet2B06ADF1:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone:
        Fn::Select:
          - 0
          - Fn::GetAZs: ""
      CidrBlock: 10.0.0.0/24
      MapPublicIpOnLaunch: true
      Tags:
        - Key: aws-cdk:subnet-name
          Value: public
        - Key: aws-cdk:subnet-type
          Value: Public
        - Key: Name
          Value: InfraStack/BookstoreVpc/publicSubnet1
      VpcId:
        Ref: BookstoreVpcB6D31B20
    Metadata:
      aws:cdk:path: InfraStack/BookstoreVpc/publicSubnet1/Subnet
  BookstoreVpcpublicSubnet1RouteTableAADC7D08:
    Type: AWS::EC2::RouteTable
    Properties:
      Tags:
        - Key: Name
          Value: InfraStack/BookstoreVpc/publicSubnet1
      VpcId:
        Ref: BookstoreVpcB6D31B20
    Metadata:
      aws:cdk:path: InfraStack/BookstoreVpc/publicSubnet1/RouteTable
  BookstoreVpcpublicSubnet1RouteTableAssociation7588970E:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId:
        Ref: BookstoreVpcpublicSubnet1RouteTableAADC7D08
      SubnetId:
        Ref: BookstoreVpcpublicSubnet1Subnet2B06ADF1
    Metadata:
      aws:cdk:path: InfraStack/BookstoreVpc/publicSubnet1/RouteTableAssociation
  BookstoreVpcpublicSubnet1DefaultRoute6C739D46:
    Type: AWS::EC2::Route
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId:
        Ref: BookstoreVpcIGWA5BD039C
      RouteTableId:
        Ref: BookstoreVpcpublicSubnet1RouteTableAADC7D08
    DependsOn:
      - BookstoreVpcVPCGW63CA15A8
    Metadata:
      aws:cdk:path: InfraStack/BookstoreVpc/publicSubnet1/DefaultRoute
  BookstoreVpcpublicSubnet1EIPAE617268:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: InfraStack/BookstoreVpc/publicSubnet1
    Metadata:
      aws:cdk:path: InfraStack/BookstoreVpc/publicSubnet1/EIP
  BookstoreVpcpublicSubnet1NATGatewayA81FE2FD:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId:
        Fn::GetAtt:
          - BookstoreVpcpublicSubnet1EIPAE617268
          - AllocationId
      SubnetId:
        Ref: BookstoreVpcpublicSubnet1Subnet2B06ADF1
      Tags:
        - Key: Name
          Value: InfraStack/BookstoreVpc/publicSubnet1
    DependsOn:
      - BookstoreVpcpublicSubnet1DefaultRoute6C739D46
      - BookstoreVpcpublicSubnet1RouteTableAssociation7588970E
    Metadata:
      aws:cdk:path: InfraStack/BookstoreVpc/publicSubnet1/NATGateway
  BookstoreVpcpublicSubnet2Subnet1FBBE3E9:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone:
        Fn::Select:
          - 1
          - Fn::GetAZs: ""
      CidrBlock: 10.0.1.0/24
      MapPublicIpOnLaunch: true
      Tags:
        - Key: aws-cdk:subnet-name
          Value: public
        - Key: aws-cdk:subnet-type
          Value: Public
        - Key: Name
          Value: InfraStack/BookstoreVpc/publicSubnet2
      VpcId:
        Ref: BookstoreVpcB6D31B20
    Metadata:
      aws:cdk:path: InfraStack/BookstoreVpc/publicSubnet2/Subnet
  BookstoreVpcpublicSubnet2RouteTable678FAD72:
    Type: AWS::EC2::RouteTable
    Properties:
      Tags:
        - Key: Name
          Value: InfraStack/BookstoreVpc/publicSubnet2
      VpcId:
        Ref: BookstoreVpcB6D31B20
    Metadata:
      aws:cdk:path: InfraStack/BookstoreVpc/publicSubnet2/RouteTable
  BookstoreVpcpublicSubnet2RouteTableAssociation6F59FC3D:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId:
        Ref: BookstoreVpcpublicSubnet2RouteTable678FAD72
      SubnetId:
        Ref: BookstoreVpcpublicSubnet2Subnet1FBBE3E9
    Metadata:
      aws:cdk:path: InfraStack/BookstoreVpc/publicSubnet2/RouteTableAssociation
  BookstoreVpcpublicSubnet2DefaultRouteAA292F4A:
    Type: AWS::EC2::Route
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId:
        Ref: BookstoreVpcIGWA5BD039C
      RouteTableId:
        Ref: BookstoreVpcpublicSubnet2RouteTable678FAD72
    DependsOn:
      - BookstoreVpcVPCGW63CA15A8
    Metadata:
      aws:cdk:path: InfraStack/BookstoreVpc/publicSubnet2/DefaultRoute
  BookstoreVpcprivateegressSubnet1SubnetA0ACB0C8:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone:
        Fn::Select:
          - 0
          - Fn::GetAZs: ""
      CidrBlock: 10.0.2.0/24
      MapPublicIpOnLaunch: false
      Tags:
        - Key: aws-cdk:subnet-name
          Value: private-egress
        - Key: aws-cdk:subnet-type
          Value: Private
        - Key: Name
          Value: InfraStack/BookstoreVpc/private-egressSubnet1
      VpcId:
        Ref: BookstoreVpcB6D31B20
    Metadata:
      aws:cdk:path: InfraStack/BookstoreVpc/private-egressSubnet1/Subnet
  BookstoreVpcprivateegressSubnet1RouteTableA327A40B:
    Type: AWS::EC2::RouteTable
    Properties:
      Tags:
        - Key: Name
          Value: InfraStack/BookstoreVpc/private-egressSubnet1
      VpcId:
        Ref: BookstoreVpcB6D31B20
    Metadata:
      aws:cdk:path: InfraStack/BookstoreVpc/private-egressSubnet1/RouteTable
  BookstoreVpcprivateegressSubnet1RouteTableAssociation0AF86FA4:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId:
        Ref: BookstoreVpcprivateegressSubnet1RouteTableA327A40B
      SubnetId:
        Ref: BookstoreVpcprivateegressSubnet1SubnetA0ACB0C8
    Metadata:
      aws:cdk:path: InfraStack/BookstoreVpc/private-egressSubnet1/RouteTableAssociation
  BookstoreVpcprivateegressSubnet1DefaultRouteE1F4A055:
    Type: AWS::EC2::Route
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId:
        Ref: BookstoreVpcpublicSubnet1NATGatewayA81FE2FD
      RouteTableId:
        Ref: BookstoreVpcprivateegressSubnet1RouteTableA327A40B
    Metadata:
      aws:cdk:path: InfraStack/BookstoreVpc/private-egressSubnet1/DefaultRoute
  BookstoreVpcprivateegressSubnet2Subnet414CF1D5:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone:
        Fn::Select:
          - 1
          - Fn::GetAZs: ""
      CidrBlock: 10.0.3.0/24
      MapPublicIpOnLaunch: false
      Tags:
        - Key: aws-cdk:subnet-name
          Value: private-egress
        - Key: aws-cdk:subnet-type
          Value: Private
        - Key: Name
          Value: InfraStack/BookstoreVpc/private-egressSubnet2
      VpcId:
        Ref: BookstoreVpcB6D31B20
    Metadata:
      aws:cdk:path: InfraStack/BookstoreVpc/private-egressSubnet2/Subnet
  BookstoreVpcprivateegressSubnet2RouteTableCAFF80F0:
    Type: AWS::EC2::RouteTable
    Properties:
      Tags:
        - Key: Name
          Value: InfraStack/BookstoreVpc/private-egressSubnet2
      VpcId:
        Ref: BookstoreVpcB6D31B20
    Metadata:
      aws:cdk:path: InfraStack/BookstoreVpc/private-egressSubnet2/RouteTable
  BookstoreVpcprivateegressSubnet2RouteTableAssociationD48C14B2:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId:
        Ref: BookstoreVpcprivateegressSubnet2RouteTableCAFF80F0
      SubnetId:
        Ref: BookstoreVpcprivateegressSubnet2Subnet414CF1D5
    Metadata:
      aws:cdk:path: InfraStack/BookstoreVpc/private-egressSubnet2/RouteTableAssociation
  BookstoreVpcprivateegressSubnet2DefaultRoute9CB57401:
    Type: AWS::EC2::Route
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId:
        Ref: BookstoreVpcpublicSubnet1NATGatewayA81FE2FD
      RouteTableId:
        Ref: BookstoreVpcprivateegressSubnet2RouteTableCAFF80F0
    Metadata:
      aws:cdk:path: InfraStack/BookstoreVpc/private-egressSubnet2/DefaultRoute
  BookstoreVpcIGWA5BD039C:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: InfraStack/BookstoreVpc
    Metadata:
      aws:cdk:path: InfraStack/BookstoreVpc/IGW
  BookstoreVpcVPCGW63CA15A8:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId:
        Ref: BookstoreVpcIGWA5BD039C
      VpcId:
        Ref: BookstoreVpcB6D31B20
    Metadata:
      aws:cdk:path: InfraStack/BookstoreVpc/VPCGW
  BookstoreVpcDynamoDbEndpointE4A75315:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      RouteTableIds:
        - Ref: BookstoreVpcprivateegressSubnet1RouteTableA327A40B
        - Ref: BookstoreVpcprivateegressSubnet2RouteTableCAFF80F0
      ServiceName:
        Fn::Join:
          - ""
          - - com.amazonaws.
            - Ref: AWS::Region
            - .dynamodb
      Tags:
        - Key: Name
          Value: InfraStack/BookstoreVpc
      VpcEndpointType: Gateway
      VpcId:
        Ref: BookstoreVpcB6D31B20
    Metadata:
      aws:cdk:path: InfraStack/BookstoreVpc/DynamoDbEndpoint/Resource
  BookstoreVpcS3Endpoint320F13FF:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      RouteTableIds:
        - Ref: BookstoreVpcprivateegressSubnet1RouteTableA327A40B
        - Ref: BookstoreVpcprivateegressSubnet2RouteTableCAFF80F0
      ServiceName:
        Fn::Join:
          - ""
          - - com.amazonaws.
            - Ref: AWS::Region
            - .s3
      Tags:
        - Key: Name
          Value: InfraStack/BookstoreVpc
      VpcEndpointType: Gateway
      VpcId:
        Ref: BookstoreVpcB6D31B20
    Metadata:
      aws:cdk:path: InfraStack/BookstoreVpc/S3Endpoint/Resource
  BooksTable9DF4AE31:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
      BillingMode: PAY_PER_REQUEST
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      TableName: tb_books
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
    Metadata:
      aws:cdk:path: InfraStack/BooksTable/Resource
  AlbSGE6D0E5D1:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: ALB SG
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic by default
          IpProtocol: "-1"
      SecurityGroupIngress:
        - CidrIp: 0.0.0.0/0
          Description: Allow HTTP from anywhere
          FromPort: 80
          IpProtocol: tcp
          ToPort: 80
      VpcId:
        Ref: BookstoreVpcB6D31B20
    Metadata:
      aws:cdk:path: InfraStack/AlbSG/Resource
  BackendSG75CF71F5:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Backend SG
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic by default
          IpProtocol: "-1"
      VpcId:
        Ref: BookstoreVpcB6D31B20
    Metadata:
      aws:cdk:path: InfraStack/BackendSG/Resource
  BackendSGfromInfraStackAlbSG1E44EC545001F83EDADA:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      Description: Allow ALB to hit backend on 5001
      FromPort: 5001
      GroupId:
        Fn::GetAtt:
          - BackendSG75CF71F5
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        Fn::GetAtt:
          - AlbSGE6D0E5D1
          - GroupId
      ToPort: 5001
    Metadata:
      aws:cdk:path: InfraStack/BackendSG/from InfraStackAlbSG1E44EC54:5001
  BackendLaunchTemplateProfile38354EA6:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - LabRole
    Metadata:
      aws:cdk:path: InfraStack/BackendLaunchTemplate/Profile
  BackendLaunchTemplateA49214CA:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateData:
        IamInstanceProfile:
          Arn:
            Fn::GetAtt:
              - BackendLaunchTemplateProfile38354EA6
              - Arn
        ImageId:
          Ref: SsmParameterValueawsservicecanonicalubuntuserver2204stablecurrentamd64hvmebsgp2amiidC96584B6F00A464EAD1953AFF4B05118Parameter
        InstanceType: t3.micro
        SecurityGroupIds:
          - Fn::GetAtt:
              - BackendSG75CF71F5
              - GroupId
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Name
                Value: InfraStack/BackendLaunchTemplate
          - ResourceType: volume
            Tags:
              - Key: Name
                Value: InfraStack/BackendLaunchTemplate
        UserData:
          Fn::Base64:
            Fn::Join:
              - ""
              - - |-
                  #!/bin/bash
                  set -euxo pipefail
                  exec > >(tee -a /var/log/bookstore-bootstrap.log) 2>&1
                  export DEBIAN_FRONTEND=noninteractive
                  sudo apt-get update -y
                  sudo apt-get install -y git curl unzip ca-certificates
                  curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
                  sudo apt-get install -y nodejs
                  sudo mkdir -p /opt/bookstore
                  sudo chown ubuntu:ubuntu /opt/bookstore
                  cd /opt/bookstore
                  git clone --depth 1 --branch main https://github.com/DavidLondo/Book-Store-Node-React.git src
                  cd /opt/bookstore/src/bookstore/frontend
                  sudo -u ubuntu npm ci || sudo -u ubuntu npm install
                  sudo -u ubuntu npm run build
                  cd /opt/bookstore/src/bookstore/backend
                  echo 'NODE_ENV=production' | sudo tee .env
                  echo 'PORT=5001' | sudo tee -a .env
                  echo 'AWS_REGION=
                - Ref: AWS::Region
                - |-
                  ' | sudo tee -a .env
                  echo 'TABLE_NAME=
                - Ref: BooksTable9DF4AE31
                - |-
                  ' | sudo tee -a .env
                  sudo -u ubuntu npm ci --omit=dev || sudo -u ubuntu npm install --omit=dev
                  node seeder.js || true
                  sudo tee /etc/systemd/system/bookstore.service > /dev/null << 'EOF'
                  [Unit]
                  Description=Bookstore Backend Node Server
                  After=network.target

                  [Service]
                  Type=simple
                  User=ubuntu
                  WorkingDirectory=/opt/bookstore/src/bookstore/backend
                  EnvironmentFile=/opt/bookstore/src/bookstore/backend/.env
                  ExecStart=/usr/bin/node server.js
                  Restart=always
                  RestartSec=3

                  [Install]
                  WantedBy=multi-user.target
                  EOF
                  sudo systemctl daemon-reload
                  sudo systemctl enable bookstore
                  sudo systemctl start bookstore
                  for i in $(seq 1 60); do curl -fsS http://127.0.0.1:5001/healthz && break || sleep 5; done || true
                  sudo systemctl status bookstore --no-pager || true
                  journalctl -u bookstore -n 200 --no-pager || true
      TagSpecifications:
        - ResourceType: launch-template
          Tags:
            - Key: Name
              Value: InfraStack/BackendLaunchTemplate
    Metadata:
      aws:cdk:path: InfraStack/BackendLaunchTemplate/Resource
  BackendAsgASG36DB4B64:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      DesiredCapacity: "2"
      HealthCheckGracePeriod: 180
      HealthCheckType: ELB
      LaunchTemplate:
        LaunchTemplateId:
          Ref: BackendLaunchTemplateA49214CA
        Version:
          Fn::GetAtt:
            - BackendLaunchTemplateA49214CA
            - LatestVersionNumber
      MaxSize: "4"
      MinSize: "2"
      TargetGroupARNs:
        - Ref: BackendAlbHttpListenerBackendTargetsGroup1445D956
      VPCZoneIdentifier:
        - Ref: BookstoreVpcprivateegressSubnet1SubnetA0ACB0C8
        - Ref: BookstoreVpcprivateegressSubnet2Subnet414CF1D5
    UpdatePolicy:
      AutoScalingScheduledAction:
        IgnoreUnmodifiedGroupSizeProperties: true
    Metadata:
      aws:cdk:path: InfraStack/BackendAsg/ASG
  BackendAlb0D5FE5C5:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      LoadBalancerAttributes:
        - Key: deletion_protection.enabled
          Value: "false"
      Scheme: internet-facing
      SecurityGroups:
        - Fn::GetAtt:
            - AlbSGE6D0E5D1
            - GroupId
      Subnets:
        - Ref: BookstoreVpcpublicSubnet1Subnet2B06ADF1
        - Ref: BookstoreVpcpublicSubnet2Subnet1FBBE3E9
      Type: application
    DependsOn:
      - BookstoreVpcpublicSubnet1DefaultRoute6C739D46
      - BookstoreVpcpublicSubnet1RouteTableAssociation7588970E
      - BookstoreVpcpublicSubnet2DefaultRouteAA292F4A
      - BookstoreVpcpublicSubnet2RouteTableAssociation6F59FC3D
    Metadata:
      aws:cdk:path: InfraStack/BackendAlb/Resource
  BackendAlbHttpListener58B160AA:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: BackendAlbHttpListenerBackendTargetsGroup1445D956
          Type: forward
      LoadBalancerArn:
        Ref: BackendAlb0D5FE5C5
      Port: 80
      Protocol: HTTP
    Metadata:
      aws:cdk:path: InfraStack/BackendAlb/HttpListener/Resource
  BackendAlbHttpListenerBackendTargetsGroup1445D956:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      HealthCheckIntervalSeconds: 30
      HealthCheckPath: /healthz
      HealthCheckPort: "5001"
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      Matcher:
        HttpCode: "200"
      Port: 5001
      Protocol: HTTP
      TargetGroupAttributes:
        - Key: stickiness.enabled
          Value: "false"
      TargetType: instance
      UnhealthyThresholdCount: 3
      VpcId:
        Ref: BookstoreVpcB6D31B20
    Metadata:
      aws:cdk:path: InfraStack/BackendAlb/HttpListener/BackendTargetsGroup/Resource
Parameters:
  SsmParameterValueawsservicecanonicalubuntuserver2204stablecurrentamd64hvmebsgp2amiidC96584B6F00A464EAD1953AFF4B05118Parameter:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/canonical/ubuntu/server/22.04/stable/current/amd64/hvm/ebs-gp2/ami-id
Outputs:
  WebsiteURL:
    Description: Frontend+API via ALB
    Value:
      Fn::Join:
        - ""
        - - http://
          - Fn::GetAtt:
              - BackendAlb0D5FE5C5
              - DNSName
  AlbDNS:
    Description: ALB DNS for API
    Value:
      Fn::GetAtt:
        - BackendAlb0D5FE5C5
        - DNSName
  DynamoTable:
    Value:
      Ref: BooksTable9DF4AE31

